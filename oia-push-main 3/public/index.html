<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Braza Burguer</title>
  
  <!-- Script da Utmify para rastreamento de convers√µes com par√¢metro anti-cache -->
  <script async src="https://cdn.utmify.com.br/utmify.min.js?token=9jPckCj5iPZ4dPQFhMtgMX268lgzKbJbAmSV&v=1.0.3"></script>

  <!-- Facebook Pixel Code com Debug -->
  <script>
    // Debug global do Facebook Pixel
    window.facebookPixelDebug = {
      loaded: false,
      events: [],
      errors: [],
      pixelId: '1404066580873208',
      initTime: Date.now()
    };
    
    // Fun√ß√£o original do pixel
    !function(f,b,e,v,n,t,s) {
      if(f.fbq) return;
      n=f.fbq=function(){
        n.callMethod ? n.callMethod.apply(n,arguments) : n.queue.push(arguments);
        // Debug: registrar chamadas
        window.facebookPixelDebug.events.push({
          type: 'fbq_call',
          args: Array.from(arguments),
          timestamp: Date.now()
        });
      };
      if(!f._fbq) f._fbq=n;
      n.push=n; n.loaded=!0; n.version='2.0';
      n.queue=[];
      
      // Criar script com handlers de debug
      t=b.createElement(e);
      t.async=!0;
      t.src=v;
      
      // Handler de sucesso
      t.onload = function() {
        console.log('‚úÖ Facebook Pixel carregado com sucesso');
        window.facebookPixelDebug.loaded = true;
        window.facebookPixelDebug.loadTime = Date.now() - window.facebookPixelDebug.initTime;
      };
      
      // Handler de erro
      t.onerror = function() {
        console.error('‚ùå Erro ao carregar Facebook Pixel');
        window.facebookPixelDebug.errors.push({
          type: 'script_load_error',
          timestamp: Date.now()
        });
        
        // Fallback: criar pixel de backup via imagem
        createFallbackPixel();
      };
      
      s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s);
    }(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');
    
    // Fun√ß√£o para criar pixel de backup quando JavaScript falha
    function createFallbackPixel() {
      console.log('üîÑ Criando pixel de backup via imagem...');
      var img = document.createElement('img');
      img.height = 1;
      img.width = 1;
      img.style.display = 'none';
      img.src = 'https://www.facebook.com/tr?id=1404066580873208&ev=PageView&noscript=1';
      img.onload = function() {
        console.log('‚úÖ Pixel de backup carregado');
        window.facebookPixelDebug.fallbackLoaded = true;
      };
      img.onerror = function() {
        console.error('‚ùå Erro no pixel de backup');
        window.facebookPixelDebug.errors.push({
          type: 'fallback_pixel_error',
          timestamp: Date.now()
        });
      };
      document.body.appendChild(img);
    }
    
    // Inicializar pixel
    fbq('init', '1404066580873208');
    fbq('track', 'PageView');
    
    // Verifica√ß√£o peri√≥dica melhorada
    setTimeout(function() {
      if (!window.facebookPixelDebug.loaded) {
        console.warn('‚ö†Ô∏è Facebook Pixel n√£o carregou em 5 segundos');
        
        // Tentar recarregar
        const script = document.createElement('script');
        script.src = 'https://connect.facebook.net/en_US/fbevents.js';
        script.onload = function() {
          console.log('‚úÖ Facebook Pixel recarregado com sucesso');
          window.facebookPixelDebug.loaded = true;
          window.facebookPixelDebug.reloaded = true;
          fbq('init', '1404066580873208');
          fbq('track', 'PageView');
        };
        script.onerror = function() {
          console.error('‚ùå Falha no reload do Facebook Pixel, usando fallback');
          createFallbackPixel();
        };
        document.head.appendChild(script);
      }
    }, 5000);
    
    // Verificar se JavaScript est√° habilitado e criar fallback se necess√°rio
    window.addEventListener('load', function() {
      // Se ap√≥s 3 segundos o pixel principal n√£o carregou, criar fallback
      setTimeout(function() {
        if (!window.facebookPixelDebug.loaded && !window.facebookPixelDebug.fallbackLoaded) {
          console.log('üîÑ Timeout do pixel principal, criando fallback...');
          createFallbackPixel();
        }
      }, 3000);
    });
  </script>
  
  <!-- Script para verificar carregamento da Utmify -->
  <script>
    window.utmifyDebug = {
      loaded: false,
      errors: [],
      events: [],
      retryCount: 0,
      maxRetries: 5
    };
    
    // Fun√ß√£o para verificar se o script foi carregado
    function checkUtmifyLoaded() {
      console.log('üîç Verificando carregamento do script Utmify...');
      
      if (window.utmify && typeof window.utmify.conversion === 'function') {
        console.log('‚úÖ Script Utmify carregado com sucesso!');
        window.utmifyDebug.loaded = true;
        
        // Registrar evento de carregamento
        window.utmifyDebug.events.push({
          type: 'script_loaded',
          timestamp: new Date().toISOString()
        });
        
        // Capturar par√¢metros UTM da URL
        try {
          const url = new URL(window.location.href);
          const utmParams = {};
          
          ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content', 'utm_id'].forEach(param => {
            const value = url.searchParams.get(param);
            if (value) utmParams[param] = value;
          });
          
          // Salvar para debug
          window.utmifyDebug.utmParams = utmParams;
          
          console.log('üìä Par√¢metros UTM capturados:', utmParams);
          
          // Verificar se o objeto de convers√£o est√° funcionando
          console.log('üîç Testando fun√ß√£o window.utmify.conversion...');
          try {
            // Apenas verificar se a fun√ß√£o existe e pode ser chamada
            if (typeof window.utmify.conversion === 'function') {
              console.log('‚úÖ Fun√ß√£o window.utmify.conversion est√° dispon√≠vel');
            }
          } catch (convError) {
            console.error('‚ùå Erro ao testar window.utmify.conversion:', convError);
            window.utmifyDebug.errors.push({
              type: 'conversion_test_error',
              timestamp: new Date().toISOString(),
              error: String(convError)
            });
          }
        } catch (e) {
          console.error('‚ùå Erro ao capturar par√¢metros UTM:', e);
          window.utmifyDebug.errors.push({
            type: 'utm_capture_error',
            timestamp: new Date().toISOString(),
            error: String(e)
          });
        }
      } else {
        window.utmifyDebug.retryCount++;
        
        if (window.utmifyDebug.retryCount <= window.utmifyDebug.maxRetries) {
          console.warn(`‚ö†Ô∏è Script Utmify ainda n√£o carregado. Tentativa ${window.utmifyDebug.retryCount}/${window.utmifyDebug.maxRetries}...`);
          
          // Registrar tentativa
          window.utmifyDebug.errors.push({
            type: 'script_not_loaded',
            timestamp: new Date().toISOString(),
            attempt: window.utmifyDebug.retryCount
          });
          
          // Tentar novamente ap√≥s um pequeno delay
          setTimeout(checkUtmifyLoaded, 1000);
        } else {
          console.error('‚ùå Script Utmify n√£o carregou ap√≥s v√°rias tentativas. Recarregando script...');
          reloadUtmifyScript();
        }
      }
    }
    
    // Fun√ß√£o para recarregar o script Utmify
    function reloadUtmifyScript() {
      console.log('üîÑ Recarregando script Utmify...');
      
      try {
        // Remover script antigo se existir
        const oldScript = document.querySelector('script[src*="utmify.min.js"]');
        if (oldScript) {
          oldScript.remove();
          console.log('üóëÔ∏è Script antigo removido');
        }
        
        // Criar novo script com timestamp para evitar cache
        const script = document.createElement('script');
        script.async = true;
        script.src = `https://cdn.utmify.com.br/utmify.min.js?token=9jPckCj5iPZ4dPQFhMtgMX268lgzKbJbAmSV&v=${Date.now()}`;
        
        script.onload = function() {
          console.log('‚úÖ Script Utmify recarregado com sucesso');
          window.utmifyDebug.reloaded = true;
        };
        
        script.onerror = function() {
          console.error('‚ùå Erro ao recarregar script Utmify');
          window.utmifyDebug.errors.push({
            type: 'script_reload_error',
            timestamp: new Date().toISOString()
          });
        };
        
        document.head.appendChild(script);
        
        // Registrar evento de recarga
        window.utmifyDebug.events.push({
          type: 'script_reloaded',
          timestamp: new Date().toISOString()
        });
        
        // Resetar contador de tentativas
        window.utmifyDebug.retryCount = 0;
        
        // Verificar novamente ap√≥s um delay
        setTimeout(checkUtmifyLoaded, 1500);
      } catch (error) {
        console.error('‚ùå Erro cr√≠tico ao recarregar Utmify:', error);
        window.utmifyDebug.errors.push({
          type: 'critical_reload_error',
          timestamp: new Date().toISOString(),
          error: String(error)
        });
      }
    }
    
    // Iniciar verifica√ß√£o ap√≥s carregamento da p√°gina
    window.addEventListener('load', function() {
      console.log('üöÄ P√°gina carregada, iniciando verifica√ß√£o do script Utmify...');
      
      // Registrar evento de carregamento da p√°gina
      window.utmifyDebug.pageLoaded = true;
      window.utmifyDebug.pathname = window.location.pathname;
      window.utmifyDebug.userAgent = navigator.userAgent;
      
      // Verificar script ap√≥s um pequeno delay para dar tempo de carregar
      setTimeout(checkUtmifyLoaded, 800);
    });
    
    // Verificar periodicamente se o script est√° funcionando
    setInterval(function() {
      if (!window.utmifyDebug.loaded) {
        console.warn('‚ö†Ô∏è Script Utmify ainda n√£o detectado ap√≥s intervalo de verifica√ß√£o');
        
        if (window.utmifyDebug.retryCount >= window.utmifyDebug.maxRetries) {
          reloadUtmifyScript();
        }
      }
    }, 10000); // Verificar a cada 10 segundos
    
    // Fun√ß√£o para depura√ß√£o manual (pode ser chamada no console)
    window.debugUtmify = function() {
      console.log('üîç Debug do Utmify:', {
        loaded: window.utmifyDebug.loaded,
        retryCount: window.utmifyDebug.retryCount,
        errors: window.utmifyDebug.errors,
        events: window.utmifyDebug.events,
        utmParams: window.utmifyDebug.utmParams,
        utmifyObject: window.utmify
      });
    };
    
    // Fun√ß√£o para depura√ß√£o manual do Facebook Pixel
    window.debugFacebookPixel = function() {
      console.log('üîç Debug do Facebook Pixel:', {
        loaded: window.facebookPixelDebug.loaded,
        events: window.facebookPixelDebug.events,
        errors: window.facebookPixelDebug.errors,
        loadTime: window.facebookPixelDebug.loadTime,
        fallbackLoaded: window.facebookPixelDebug.fallbackLoaded,
        fbqObject: window.fbq
      });
    };
  </script>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-1R6732H3NQ"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-1R6732H3NQ');
    
    // Debug do Google Analytics
    window.debugGA = function() {
      console.log('üîç Debug do Google Analytics:', {
        dataLayer: window.dataLayer,
        gtag: window.gtag,
        gaObject: window.ga,
        gtagLoaded: typeof window.gtag === 'function'
      });
    };
  </script>
</head>
<body>
  <div id="root"></div>
  <script type="module" src="/src/main.tsx"></script>
</body>
</html>
